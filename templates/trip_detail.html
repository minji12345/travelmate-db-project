{% extends "base.html" %}

{% block content %}

<h2>{{ trip.title }}</h2>
<p>ê¸°ê°„: {{ trip.start_date }} ~ {{ trip.end_date }}</p>

{% if trip.total_budget_krw %}
  <p>ì˜ˆì‚°: {{ trip.total_budget_krw }} ì›</p>
{% endif %}

<hr>

<!-- ====================== -->
<!--      ì—¬í–‰ ì¸ì› ëª©ë¡     -->
<!-- ====================== -->

<h3>ì—¬í–‰ ì¸ì›</h3>

{% if participants %}
  <ul style="list-style:none; padding-left:0; margin-bottom:10px;">
    {% for p in participants %}
    <li style="margin-bottom:6px;">
      {{ p.name }}
      <form method="POST"
            action="{{ url_for('participant_delete',
                               trip_id=trip.trip_id,
                               user_id=p.user_id) }}"
            style="display:inline-block; margin-left:8px;"
            onsubmit="return confirm('ì´ ì¸ì›ê³¼ ê´€ë ¨ëœ ì§€ì¶œ/ì •ì‚° ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button type="submit"
                style="
                  font-size:11px;
                  padding:2px 6px;
                  border:1px solid #e57373;
                  border-radius:4px;
                  background:#ffebee;
                  color:#c62828;
                  cursor:pointer;
                ">
          ì‚­ì œ
        </button>
      </form>
    </li>
    {% endfor %}
  </ul>
{% else %}
  <p>ë“±ë¡ëœ ì¸ì›ì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<form method="POST"
      action="{{ url_for('add_participant', trip_id=trip.trip_id) }}"
      style="margin-top:5px;">
  <label>ì´ë¦„ ì¶”ê°€:</label>
  <input type="text" name="name" required>
  <button type="submit">ì¶”ê°€</button>
</form>

<hr>

<!-- ====================== -->
<!--   ì—¬í–‰ íƒ€ì„ë¼ì¸ ë³´ê¸°   -->
<!-- ====================== -->

<h3>ì—¬í–‰ íƒ€ì„ë¼ì¸</h3>

<div class="timeline">
  {% for d in destinations %}
  <div class="timeline-item"
       style="margin-bottom: 20px; padding: 10px; border-left: 4px solid #888; padding-left:10px;">

    <div class="timeline-day"
         style="font-weight:bold; font-size:18px; display:flex; align-items:center;">
      <span>Day {{ d.day_no }}</span>

      <!-- Day / ë„ì‹œ ìˆ˜ì • ë²„íŠ¼ -->
      <a href="{{ url_for('destination_edit', destination_id=d.destination_id) }}"
         style="font-size:12px;
                margin-left:10px;
                padding:2px 6px;
                border:1px solid #888;
                border-radius:4px;
                text-decoration:none;
                color:#333;">
        ìˆ˜ì •
      </a>

      <!-- Day / ë„ì‹œ ì‚­ì œ ë²„íŠ¼ -->
      <form method="POST"
            action="{{ url_for('destination_delete', destination_id=d.destination_id) }}"
            style="display:inline-block; margin-left:6px;"
            onsubmit="return confirm('ì´ Dayì— ì†í•œ ì•¡í‹°ë¹„í‹°ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\nì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?');">
        <button type="submit"
                style="font-size:12px;
                       padding:2px 6px;
                       border:1px solid #e57373;
                       border-radius:4px;
                       background:#ffebee;
                       color:#c62828;
                       cursor:pointer;">
          ì‚­ì œ
        </button>
      </form>
    </div>

    <div class="timeline-content" style="margin-left: 0; margin-top:5px;">
      <h4>{{ d.country_name }} {{ d.city_name }}</h4>

      {% if d.note %}
        <p style="color:#666;">{{ d.note }}</p>
      {% endif %}

      <h5>ì•¡í‹°ë¹„í‹°</h5>
      <ul>
        {% for a in activities if a.day_no == d.day_no %}
          <li>
            <strong>{{ a.name }}</strong>
            {% if a.cost_krw %}
              â€” {{ a.cost_krw }}ì›
            {% endif %}

            <!-- ì•¡í‹°ë¹„í‹° ìˆ˜ì • ë²„íŠ¼ -->
            <a href="{{ url_for('activity_edit', activity_id=a.activity_id) }}"
               style="font-size:11px; margin-left:6px; padding:1px 5px;
                      border:1px solid #aaa; border-radius:4px;
                      text-decoration:none; color:#333;">
              ìˆ˜ì •
            </a>

            <!-- ì•¡í‹°ë¹„í‹° ì‚­ì œ ë²„íŠ¼ -->
            <form method="POST"
                  action="{{ url_for('activity_delete', activity_id=a.activity_id) }}"
                  style="display:inline-block; margin-left:4px;"
                  onsubmit="return confirm('ì´ ì•¡í‹°ë¹„í‹°ë¥¼ ì‚­ì œí• ê¹Œìš”?');">
              <button type="submit"
                      style="font-size:11px; padding:1px 5px; border:1px solid #e57373;
                             border-radius:4px; background:#ffebee; color:#c62828;">
                ì‚­ì œ
              </button>
            </form>

            {% if a.memo %}
              <div style="font-size:12px; color:#666; margin-top:3px;">
                {{ a.memo }}
              </div>
            {% endif %}
          </li>
        {% else %}
          <li>ë“±ë¡ëœ ì•¡í‹°ë¹„í‹° ì—†ìŒ</li>
        {% endfor %}
      </ul>

      <a href="{{ url_for('activity_form', trip_id=trip.trip_id) }}">+ ì•¡í‹°ë¹„í‹° ì¶”ê°€</a>
    </div>

  </div>
  {% endfor %}
</div>

{% if destinations|length == 0 %}
  <p>ì•„ì§ ë“±ë¡ëœ Day/ë„ì‹œê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<p style="margin-top: 20px;">
  <a href="{{ url_for('destination_form', trip_id=trip.trip_id) }}">+ Day / ë„ì‹œ ì¶”ê°€</a>
</p>

<hr>

<!-- ====================== -->
<!--      ì§€ì¶œ ë‚´ì—­         -->
<!-- ====================== -->

<h3>ì§€ì¶œ ë‚´ì—­</h3>
<p>
  <a href="{{ url_for('expense_form', trip_id=trip.trip_id) }}">+ ì§€ì¶œ ì¶”ê°€</a>
</p>

<table border="1" cellpadding="6" style="border-collapse:collapse;">
  <tr>
    <th>ê²°ì œì</th>
    <th>ì¹´í…Œê³ ë¦¬</th>
    <th>ì›ë˜ ê¸ˆì•¡</th>
    <th>í™˜ì‚° ê¸ˆì•¡(ì›)</th>
    <th>ê²°ì œì¼ì‹œ</th>
    <th>ë©”ëª¨</th>
    <th>ìˆ˜ì •/ì‚­ì œ</th>
  </tr>

  {% for e in expenses %}
  <tr>
    <td>{{ e.payer_name }}</td>
    <td>{{ e.category }}</td>
    <td>
      {% if e.amount %}
        {{ e.amount }} {{ e.currency_code }}
      {% else %}
        -
      {% endif %}
    </td>
    <td>{{ e.amount_krw }}</td>
    <td>{{ e.paid_at }}</td>
    <td>{{ e.memo }}</td>
    <td>
      <!-- ì§€ì¶œ ìˆ˜ì • ë²„íŠ¼ -->
      <a href="{{ url_for('expense_edit', expense_id=e.expense_id) }}"
         style="font-size:11px; padding:2px 6px; border:1px solid #888;
                border-radius:4px; text-decoration:none; color:#333;">
        ìˆ˜ì •
      </a>

      <!-- ì§€ì¶œ ì‚­ì œ ë²„íŠ¼ -->
      <form method="POST"
            action="{{ url_for('expense_delete', expense_id=e.expense_id) }}"
            style="display:inline-block; margin-left:4px;"
            onsubmit="return confirm('ì´ ì§€ì¶œ ë‚´ì—­ì„ ì‚­ì œí• ê¹Œìš”?');">
        <button type="submit"
                style="font-size:11px; padding:2px 6px; border:1px solid #e57373;
                       border-radius:4px; background:#ffebee; color:#c62828;">
          ì‚­ì œ
        </button>
      </form>
    </td>
  </tr>
  {% endfor %}
</table>

{% if not expenses %}
  <p>ì•„ì§ ë“±ë¡ëœ ì§€ì¶œì´ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr>

<!-- ====================== -->
<!--      ì •ì‚° ê²°ê³¼         -->
<!-- ====================== -->

<h3>ì •ì‚° ê²°ê³¼ (ê°œì¸ë³„)</h3>

<table border="1" cellpadding="6" style="border-collapse:collapse;">
  <tr>
    <th>ì´ë¦„</th>
    <th>ìµœì¢… ê²°ì œì•¡(ì›)</th>
    <th>ì´ ë¶€ë‹´ì•¡(ì›)</th>
    <th>ì •ì‚° ê²°ê³¼</th>
  </tr>

  {% for s in settlement %}
  <tr>
    <td>{{ s.name }}</td>
    <td>{{ s.final_paid }}</td>
    <td>{{ s.total_share }}</td>
    <td>
      {% if s.balance > 0 %}
        +{{ s.balance }} ì› ë°›ì„ ì‚¬ëŒ
      {% elif s.balance < 0 %}
        -{{ -s.balance }} ì› ë” ë‚´ì•¼ í•¨
      {% else %}
        0ì› (ì •ì‚° ì™„ë£Œ)
      {% endif %}
    </td>
  </tr>
  {% endfor %}
</table>

{% if settlement|length == 0 %}
  <p>ì •ì‚° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
{% endif %}

<hr>

<!-- ====================== -->
<!--   ì†¡ê¸ˆ ë§¤ì¹­ / ë²„íŠ¼     -->
<!-- ====================== -->

<h3>ì†¡ê¸ˆ ì •ë¦¬</h3>

{% if transactions %}
<div style="padding:15px; background:#f7f7ff; border:1px solid #ccc; border-radius:8px;">
  <ul style="list-style:none; padding-left:0;">
    {% for t in transactions %}
    <li style="margin-bottom:12px;">
      <strong>{{ t.from }}</strong> â†’ <strong>{{ t.to }}</strong>
      <span style="font-weight:bold; color:#2a4bd7;">{{ t.amount }}ì›</span>

      <form method="POST"
            action="{{ url_for('settlement_done', trip_id=trip.trip_id) }}"
            style="display:inline-block; margin-left:10px;">
        <input type="hidden" name="payer" value="{{ t.from }}">
        <input type="hidden" name="receiver" value="{{ t.to }}">
        <input type="hidden" name="amount" value="{{ t.amount }}">
        <button type="submit"
                style="padding:3px 10px; background:#4CAF50; color:white;
                       border:none; border-radius:5px;">
          ë³´ëƒˆìŠµë‹ˆë‹¤
        </button>
      </form>
    </li>
    {% endfor %}
  </ul>
</div>
{% else %}
<p style="color:gray;">ëª¨ë“  ì†¡ê¸ˆì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ‰</p>
{% endif %}

<hr>

{% endblock %}
